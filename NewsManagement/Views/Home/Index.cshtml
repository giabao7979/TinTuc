@{
    ViewBag.Title = "Trang chủ - Tin tức mới nhất";
}

<!-- Link đến CSS cải thiện -->
<link href="~/Content/css/home-page.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css" rel="stylesheet" />
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

<div class="container-fluid">
    <!-- Header với gradient đẹp -->
    <div class="main-header">
        <div class="container">
            <div class="text-center">
                <h1><i class="fas fa-newspaper mr-3"></i>Hệ thống quản lý tin tức</h1>
                <p class="lead">Cập nhật tin tức mới nhất và quản lý nội dung hiệu quả</p>
                <hr class="bg-white" style="opacity: 0.3;">
                <div class="header-buttons">
                    <a href="@Url.Action("Create", "News")" class="btn btn-light">
                        <i class="fa fa-plus mr-2"></i>Thêm tin tức
                    </a>
                    <a href="@Url.Action("Index", "News")" class="btn btn-light">
                        <i class="fa fa-list mr-2"></i>Quản lý tin tức
                    </a>
                    <a href="@Url.Action("Index", "Category")" class="btn btn-light">
                        <i class="fa fa-folder mr-2"></i>Quản lý danh mục
                    </a>
                    <button onclick="loadCategoryNews(currentCategoryId || 1)" class="btn btn-light">
                        <i class="fa fa-redo mr-2"></i>Tải lại
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="row">
            <!-- Categories Sidebar với phân cấp rõ ràng -->
            <div class="col-lg-4 col-md-5">
                <div class="card categories-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-sitemap mr-2"></i>Danh mục tin tức
                        </h5>
                        <small class="d-block mt-1 opacity-75">
                            <i class="fas fa-info-circle mr-1"></i>Click để xem tin tức,
                            <i class="fas fa-chevron-right mr-1"></i> để mở rộng
                        </small>
                    </div>
                    <div class="card-body p-0">
                        <div id="categories-menu">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary"></div>
                                <p>Đang tải danh mục...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Legend cho các cấp danh mục -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info mr-2"></i>Chú thích</h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="small">
                            <div class="d-flex align-items-center mb-2">
                                <div class="category-icon text-primary mr-2"><i class="fas fa-folder"></i></div>
                                <span>Danh mục chính</span>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <div class="category-icon text-success mr-2"><i class="fas fa-folder-open"></i></div>
                                <span>Danh mục con cấp 1</span>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <div class="category-icon text-warning mr-2"><i class="fas fa-file-alt"></i></div>
                                <span>Danh mục con cấp 2</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="category-icon text-danger mr-2"><i class="fas fa-file"></i></div>
                                <span>Danh mục con cấp 3+</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Navigation -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-fast-forward mr-2"></i>Chuyển nhanh</h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="btn-group-vertical btn-group-sm w-100" role="group">
                            <button type="button" class="btn btn-outline-primary mb-1" onclick="loadCategoryNews(1)">
                                <i class="fas fa-folder mr-1"></i>Danh mục 1
                            </button>
                            <button type="button" class="btn btn-outline-success mb-1" onclick="loadCategoryNews(2)">
                                <i class="fas fa-folder mr-1"></i>Danh mục 2
                            </button>
                            <button type="button" class="btn btn-outline-warning mb-1" onclick="loadCategoryNews(3)">
                                <i class="fas fa-folder mr-1"></i>Danh mục 3
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="loadCategoryNews(4)">
                                <i class="fas fa-folder mr-1"></i>Danh mục 4
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="col-lg-8 col-md-7">
                <!-- Search Card -->
                <div class="card search-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-search mr-2"></i>Tìm kiếm tin tức
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="input-group search-input-group">
                            <input type="text" id="search-input" class="form-control"
                                   placeholder="Nhập từ khóa tìm kiếm trong tiêu đề, trích ngắn hoặc nội dung tin tức...">
                            <div class="input-group-append">
                                <button type="button" onclick="performSearch()" class="btn btn-primary">
                                    <i class="fa fa-search mr-1"></i>Tìm kiếm
                                </button>
                                <button type="button" onclick="clearSearch()" class="btn btn-secondary">
                                    <i class="fa fa-times mr-1"></i>Xóa
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb mr-1"></i>
                                Mẹo: Nhập ít nhất 2 ký tự để bắt đầu tìm kiếm. Bấm "Xóa" để quay lại danh mục hiện tại.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- News Content -->
                <div class="card content-card">
                    <div class="card-header" id="content-header">
                        <h3 class="mb-0" id="content-title">
                            <i class="fas fa-newspaper mr-2"></i>Tin tức ở danh mục 1
                        </h3>
                        <small class="d-block mt-1 opacity-75" id="content-subtitle">
                            Đang tải tin tức từ danh mục đầu tiên...
                        </small>
                    </div>
                    <div class="card-body">
                        <div id="content-container" class="content-container">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary"></div>
                                <p>Đang tải tin tức từ danh mục 1...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="~/Js/home-page.js"></script>

<!-- Inline script to use the updated JavaScript -->
<script>
    // Global variables for tracking current state
    var currentMode = 'category';
    var currentCategoryId = 1; // Default to category 1
    var currentCategoryName = '';
    var searchTimeout;

    // Initialize page - updated version
    $(document).ready(function () {
        console.log('🚀 Page loaded, initializing with category 1...');

        // Load categories first
        loadCategories();

        // Wait a bit then auto-load category 1 news
        setTimeout(function () {
            console.log('⏰ Auto-loading category 1 news...');
            loadCategoryNews(1);
        }, 1000);

        // Search input events
        $('#search-input').on('keyup', function (e) {
            if (e.key === 'Enter') {
                performSearch();
                return;
            }

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function () {
                var query = $('#search-input').val().trim();
                if (query.length >= 2) {
                    performSearch();
                } else if (query.length === 0) {
                    clearSearch();
                }
            }, 500);
        });

        console.log('✅ Page initialization completed');
    });

    // ===== MAIN FUNCTION: Load news by category ID =====
    function loadCategoryNews(categoryId) {
        console.log('🔄 loadCategoryNews called with categoryId:', categoryId);

        if (!categoryId) {
            console.error('❌ Missing categoryId');
            return;
        }

        // Find category name from loaded categories
        var categoryName = findCategoryNameById(categoryId);
        if (!categoryName) {
            categoryName = 'Danh mục ' + categoryId;
        }

        console.log('📁 Loading news for category:', categoryId, '-', categoryName);

        // Update global state
        currentCategoryId = categoryId;
        currentCategoryName = categoryName;
        currentMode = 'category';

        // Set active state
        setActiveCategory(categoryId);

        // Update UI
        updateHeader('Tin tức ở danh mục: ' + categoryName);
        updateSubtitle('Đang tải tin tức...');
        showCategoryLoading(categoryName);

        // Add loading state
        addCategoryLoadingState(categoryId);

        // Make AJAX request
        $.ajax({
            url: '/Home/GetNewsByCategory',
            type: 'GET',
            data: {
                categoryId: categoryId,
                page: 1,
                pageSize: 20
            },
            dataType: 'json',
            timeout: 15000,
            success: function (data) {
                console.log('✅ Category news loaded:', data);

                // Remove loading state
                removeCategoryLoadingState(categoryId);

                if (data.success) {
                    if (data.data && data.data.length > 0) {
                        console.log('📊 Successfully loaded ' + data.data.length + ' news items');

                        // Update header
                        updateHeader('Tin tức ở danh mục: ' + categoryName);
                        updateSubtitle('Tìm thấy ' + data.totalCount + ' tin tức');

                        // Display news
                        displayCategoryNews(data.data, categoryName, data.totalCount);

                        // Success notification
                        showSuccessMessage('Đã tải ' + data.data.length + ' tin tức từ "' + categoryName + '"');
                    } else {
                        console.log('ℹ️ No news found for this category');
                        updateHeader('Tin tức ở danh mục: ' + categoryName);
                        updateSubtitle('Danh mục này chưa có tin tức');
                        showNoCategoryNews(categoryName);
                    }
                } else {
                    console.error('❌ API returned error:', data.message);
                    updateHeader('Lỗi tải danh mục: ' + categoryName);
                    updateSubtitle('Có lỗi xảy ra khi tải dữ liệu');
                    showCategoryError(categoryName + ' (API Error: ' + (data.message || 'Unknown') + ')');
                }
            },
            error: function (xhr, status, error) {
                console.error('❌ AJAX Error:', {
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusCode: xhr.status
                });

                // Remove loading state
                removeCategoryLoadingState(categoryId);

                var errorMsg = 'Lỗi kết nối';
                if (xhr.status === 404) {
                    errorMsg = 'API không tìm thấy';
                } else if (xhr.status === 500) {
                    errorMsg = 'Lỗi server';
                } else if (status === 'timeout') {
                    errorMsg = 'Hết thời gian chờ';
                }

                updateHeader('Lỗi tải danh mục: ' + categoryName);
                updateSubtitle('Không thể kết nối đến server');
                showCategoryError(categoryName + ' (' + errorMsg + ')');

                // Error notification
                showErrorMessage('Không thể tải tin tức từ "' + categoryName + '"');
            }
        });
    }

    // ===== HELPER: Find category name by ID =====
    function findCategoryNameById(categoryId) {
        var categoryName = '';

        // Search in loaded category links
        $('[data-category-id="' + categoryId + '"]').each(function () {
            var name = $(this).attr('data-category-name');
            if (name) {
                categoryName = name;
                return false; // Break loop
            }
        });

        return categoryName;
    }

    // ===== COMPATIBILITY: Keep old function name for existing event listeners =====
    function loadNewsByCategory(categoryId, categoryName) {
        // If categoryName is provided, update the global variable
        if (categoryName) {
            currentCategoryName = categoryName;
        }

        // Call the main function
        loadCategoryNews(categoryId);
    }

    // ===== DISPLAY FUNCTIONS =====
    function displayCategoryNews(newsArray, categoryName, totalCount) {
        console.log('✅ displayCategoryNews called with:', {
            newsCount: newsArray ? newsArray.length : 0,
            categoryName: categoryName,
            totalCount: totalCount
        });

        var html = '';

        // Header thông tin danh mục với style mới
        html += '<div class="alert alert-primary border-left-primary mb-4">';
        html += '<div class="d-flex align-items-center">';
        html += '<i class="fas fa-folder-open mr-3" style="font-size: 1.5rem;"></i>';
        html += '<div>';
        html += '<h5 class="mb-1"><strong>Tin tức ở danh mục: ' + escapeHtml(categoryName) + '</strong></h5>';
        html += '<small class="text-muted">Tìm thấy ' + totalCount + ' tin tức trong danh mục này</small>';
        html += '</div>';
        html += '</div>';
        html += '</div>';

        // Hiển thị tin tức
        if (newsArray && newsArray.length > 0) {
            html += '<div class="row">';

            for (var i = 0; i < newsArray.length; i++) {
                var news = newsArray[i];
                html += generateNewsCard(news, true);
            }

            html += '</div>';

            // Thông tin tổng kết
            if (totalCount > newsArray.length) {
                html += '<div class="alert alert-info mt-3">';
                html += '<i class="fas fa-info-circle mr-2"></i>';
                html += 'Hiển thị ' + newsArray.length + ' trong tổng số ' + totalCount + ' tin tức. ';
                html += '<button class="btn btn-sm btn-outline-primary ml-2" onclick="loadMoreNews()">Tải thêm</button>';
                html += '</div>';
            }
        } else {
            // Không có tin tức
            html += '<div class="alert alert-warning text-center">';
            html += '<h4><i class="fas fa-folder-open mr-2"></i>Danh mục trống</h4>';
            html += '<p>Danh mục "<strong>' + escapeHtml(categoryName) + '</strong>" chưa có tin tức nào.</p>';
            html += '<div class="mt-3">';
            html += '<a href="/News/Create" class="btn btn-primary mr-2">';
            html += '<i class="fas fa-plus mr-1"></i>Thêm tin tức mới';
            html += '</a>';
            html += '</div>';
            html += '</div>';
        }

        // Navigation buttons
        html += '<div class="text-center mt-4">';
        html += '<div class="btn-group" role="group">';

        // Previous category button
        if (currentCategoryId > 1) {
            html += '<button onclick="loadCategoryNews(' + (currentCategoryId - 1) + ')" class="btn btn-outline-secondary">';
            html += '<i class="fas fa-chevron-left mr-1"></i>Danh mục trước';
            html += '</button>';
        }

        // Reload current category
        html += '<button onclick="loadCategoryNews(' + currentCategoryId + ')" class="btn btn-outline-primary">';
        html += '<i class="fas fa-redo mr-1"></i>Tải lại';
        html += '</button>';

        // Next category button
        html += '<button onclick="loadCategoryNews(' + (currentCategoryId + 1) + ')" class="btn btn-outline-secondary">';
        html += 'Danh mục tiếp<i class="fas fa-chevron-right ml-1"></i>';
        html += '</button>';

        html += '</div>';
        html += '</div>';

        // Update content
        $('#content-container').html(html);

        console.log('✅ Content updated successfully');

        // Scroll to content
        $('html, body').animate({
            scrollTop: $('#content-container').offset().top - 100
        }, 500);
    }

    // Include all other functions from the updated JavaScript file...
    // (All the functions from the artifact above should be included here)
</script>