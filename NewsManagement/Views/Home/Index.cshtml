@{
    ViewBag.Title = "Trang chủ - Tin tức mới nhất";
}

<!-- Link đến CSS cải thiện -->
<link href="~/Content/css/home-page.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css" rel="stylesheet" />
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

<div class="container-fluid">
    <!-- Header với gradient đẹp -->
    <div class="main-header">
        <div class="container">
            <div class="text-center">
                <h1><i class="fas fa-newspaper mr-3"></i>Hệ thống quản lý tin tức</h1>
                <p class="lead">Cập nhật tin tức mới nhất và quản lý nội dung hiệu quả</p>
                <hr class="bg-white" style="opacity: 0.3;">
                <div class="header-buttons">
                    <a href="@Url.Action("Create", "News")" class="btn btn-light">
                        <i class="fa fa-plus mr-2"></i>Thêm tin tức
                    </a>
                    <a href="@Url.Action("Index", "News")" class="btn btn-light">
                        <i class="fa fa-list mr-2"></i>Quản lý tin tức
                    </a>
                    <a href="@Url.Action("Index", "Category")" class="btn btn-light">
                        <i class="fa fa-folder mr-2"></i>Quản lý danh mục
                    </a>
                    <button onclick="loadHomePage()" class="btn btn-light">
                        <i class="fa fa-home mr-2"></i>Tải lại trang
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="row">
            <!-- Categories Sidebar với phân cấp rõ ràng -->
            <div class="col-lg-4 col-md-5">
                <div class="card categories-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-sitemap mr-2"></i>Danh mục tin tức
                        </h5>
                        <small class="d-block mt-1 opacity-75">
                            <i class="fas fa-info-circle mr-1"></i>Click để xem tin tức,
                            <i class="fas fa-chevron-right mr-1"></i> để mở rộng
                        </small>
                    </div>
                    <div class="card-body p-0">
                        <div id="categories-menu">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary"></div>
                                <p>Đang tải danh mục...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Legend cho các cấp danh mục -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info mr-2"></i>Chú thích</h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="small">
                            <div class="d-flex align-items-center mb-2">
                                <div class="category-icon text-primary mr-2"><i class="fas fa-folder"></i></div>
                                <span>Danh mục chính</span>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <div class="category-icon text-success mr-2"><i class="fas fa-folder-open"></i></div>
                                <span>Danh mục con cấp 1</span>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <div class="category-icon text-warning mr-2"><i class="fas fa-file-alt"></i></div>
                                <span>Danh mục con cấp 2</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="category-icon text-danger mr-2"><i class="fas fa-file"></i></div>
                                <span>Danh mục con cấp 3+</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="col-lg-8 col-md-7">
                <!-- Search Card -->
                <div class="card search-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-search mr-2"></i>Tìm kiếm tin tức
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="input-group search-input-group">
                            <input type="text" id="search-input" class="form-control"
                                   placeholder="Nhập từ khóa tìm kiếm trong tiêu đề, trích ngắn hoặc nội dung tin tức...">
                            <div class="input-group-append">
                                <button type="button" onclick="performSearch()" class="btn btn-primary">
                                    <i class="fa fa-search mr-1"></i>Tìm kiếm
                                </button>
                                <button type="button" onclick="clearSearch()" class="btn btn-secondary">
                                    <i class="fa fa-times mr-1"></i>Xóa
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb mr-1"></i>
                                Mẹo: Nhập ít nhất 2 ký tự để bắt đầu tìm kiếm
                            </small>
                        </div>
                    </div>
                </div>

                <!-- News Content -->
                <div class="card content-card">
                    <div class="card-header" id="content-header">
                        <h3 class="mb-0" id="content-title">
                            <i class="fas fa-newspaper mr-2"></i>Tin tức mới nhất
                        </h3>
                        <small class="d-block mt-1 opacity-75" id="content-subtitle">
                            Cập nhật tin tức mới nhất trong hệ thống
                        </small>
                    </div>
                    <div class="card-body">
                        <div id="content-container" class="content-container">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary"></div>
                                <p>Đang tải tin tức...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script src="~/Js/home-page.js"></script>
<script>// ===== FIXED JAVASCRIPT - SỬA LỖI displayCategoryNews =====

    // Global variables
    var currentMode = 'default';
    var searchTimeout;

    // Initialize page
    $(document).ready(function () {
        console.log('Page loaded, initializing...');
        loadRecentNews();
        loadCategories();

        // Search input events
        $('#search-input').on('keyup', function (e) {
            if (e.key === 'Enter') {
                performSearch();
                return;
            }

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function () {
                var query = $('#search-input').val().trim();
                if (query.length >= 2) {
                    performSearch();
                } else if (query.length === 0) {
                    clearSearch();
                }
            }, 500);
        });
    });

    // ===== FIXED: displayCategoryNews function =====
    function displayCategoryNews(newsArray, categoryName, totalCount) {
        console.log('✅ displayCategoryNews called with:', {
            newsCount: newsArray ? newsArray.length : 0,
            categoryName: categoryName,
            totalCount: totalCount
        });

        var html = '';

        // Header thông tin danh mục
        html += '<div class="alert alert-success border-left-success mb-4">';
        html += '<div class="d-flex align-items-center">';
        html += '<i class="fas fa-folder-open mr-3" style="font-size: 1.5rem;"></i>';
        html += '<div>';
        html += '<strong>Danh mục: ' + escapeHtml(categoryName) + '</strong><br>';
        html += '<small>Tìm thấy ' + totalCount + ' tin tức</small>';
        html += '</div>';
        html += '</div>';
        html += '</div>';

        // Hiển thị tin tức
        if (newsArray && newsArray.length > 0) {
            html += '<div class="row">';

            for (var i = 0; i < newsArray.length; i++) {
                var news = newsArray[i];
                html += generateNewsCard(news, true);
            }

            html += '</div>';

            // Thông tin tổng kết
            if (totalCount > newsArray.length) {
                html += '<div class="alert alert-info mt-3">';
                html += '<i class="fas fa-info-circle mr-2"></i>';
                html += 'Hiển thị ' + newsArray.length + ' trong tổng số ' + totalCount + ' tin tức';
                html += '</div>';
            }
        } else {
            // Không có tin tức
            html += '<div class="alert alert-warning text-center">';
            html += '<h4><i class="fas fa-folder-open mr-2"></i>Danh mục trống</h4>';
            html += '<p>Danh mục này chưa có tin tức nào.</p>';
            html += '</div>';
        }

        // Nút quay lại
        html += '<div class="text-center mt-4">';
        html += '<button onclick="clearSearch()" class="btn btn-outline-secondary btn-lg">';
        html += '<i class="fas fa-arrow-left mr-2"></i>Quay lại trang chủ';
        html += '</button>';
        html += '</div>';

        // Cập nhật nội dung
        $('#content-container').html(html);

        console.log('✅ Content updated successfully');

        // Scroll to content
        $('html, body').animate({
            scrollTop: $('#content-container').offset().top - 100
        }, 500);
    }

    // ===== FIXED: generateNewsCard function =====
    function generateNewsCard(news, showCategories = false) {
        var html = '<div class="col-lg-4 col-md-6 mb-4">';
        html += '<div class="card news-card h-100 shadow-sm">';
        html += '<div class="card-body d-flex flex-column">';

        // Title
        html += '<h5 class="news-title mb-3">';
        html += '<a href="/News/Details/' + news.Id + '" class="text-decoration-none">';
        html += escapeHtml(news.Title);
        html += '</a>';
        html += '</h5>';

        // Categories (if enabled)
        if (showCategories && news.Categories && news.Categories.length > 0) {
            html += '<div class="mb-2">';
            for (var j = 0; j < news.Categories.length; j++) {
                html += '<span class="badge badge-secondary mr-1 mb-1">';
                html += escapeHtml(news.Categories[j]);
                html += '</span>';
            }
            html += '</div>';
        }

        // Summary
        if (news.Summary) {
            html += '<p class="news-summary text-muted flex-grow-1">';
            html += escapeHtml(news.Summary);
            html += '</p>';
        }

        // Meta info
        html += '<div class="news-meta mt-auto pt-3 border-top">';
        html += '<div class="d-flex justify-content-between align-items-center">';
        html += '<small class="text-muted">';
        html += '<i class="far fa-calendar-alt mr-1"></i>';
        html += escapeHtml(news.CreatedDate);
        html += '</small>';
        html += '<a href="/News/Details/' + news.Id + '" class="btn btn-sm btn-outline-primary">';
        html += '<i class="fas fa-eye mr-1"></i>Xem';
        html += '</a>';
        html += '</div>';
        html += '</div>';

        html += '</div></div></div>';

        return html;
    }

    // ===== FIXED: loadNewsByCategory với debugging =====
    function loadNewsByCategory(categoryId, categoryName) {
        console.log('🔄 loadNewsByCategory called:', {
            categoryId: categoryId,
            categoryName: categoryName,
            categoryIdType: typeof categoryId,
            categoryNameType: typeof categoryName
        });

        if (!categoryId || !categoryName) {
            console.error('❌ Missing parameters:', { categoryId, categoryName });
            return;
        }

        // 1. Set active state
        setActiveCategory(categoryId);

        // 2. Update UI
        currentMode = 'category';
        updateHeader('Đang tải tin tức từ: ' + categoryName);
        updateSubtitle('Vui lòng chờ trong giây lát...');
        showCategoryLoading(categoryName);

        // 3. Add loading state
        addCategoryLoadingState(categoryId);

        // 4. Make AJAX request
        console.log('🌐 Making AJAX request to /Home/GetNewsByCategory');

        $.ajax({
            url: '/Home/GetNewsByCategory',
            type: 'GET',
            data: {
                categoryId: categoryId,
                page: 1,
                pageSize: 20
            },
            dataType: 'json',
            timeout: 15000,
            success: function (data) {
                console.log('✅ AJAX Success:', data);

                // Remove loading state
                removeCategoryLoadingState(categoryId);

                if (data.success) {
                    if (data.data && data.data.length > 0) {
                        console.log('📊 Successfully loaded ' + data.data.length + ' news items');

                        // Update header
                        updateHeader('Tin tức trong danh mục: ' + categoryName);
                        updateSubtitle('Tìm thấy ' + data.totalCount + ' tin tức');

                        // *** FIXED: Gọi displayCategoryNews ***
                        console.log('🎯 Calling displayCategoryNews...');
                        displayCategoryNews(data.data, categoryName, data.totalCount);

                        // Success notification
                        showSuccessMessage('Đã tải ' + data.data.length + ' tin tức từ "' + categoryName + '"');
                    } else {
                        console.log('ℹ️ No news found for this category');
                        updateHeader('Danh mục trống: ' + categoryName);
                        updateSubtitle('Danh mục này chưa có tin tức');
                        showNoCategoryNews(categoryName);
                    }
                } else {
                    console.error('❌ API returned error:', data.message);
                    updateHeader('Lỗi tải danh mục: ' + categoryName);
                    updateSubtitle('Có lỗi xảy ra khi tải dữ liệu');
                    showCategoryError(categoryName + ' (API Error: ' + (data.message || 'Unknown') + ')');
                }
            },
            error: function (xhr, status, error) {
                console.error('❌ AJAX Error:', {
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusCode: xhr.status
                });

                // Remove loading state
                removeCategoryLoadingState(categoryId);

                var errorMsg = 'Lỗi kết nối';
                if (xhr.status === 404) {
                    errorMsg = 'API không tìm thấy';
                } else if (xhr.status === 500) {
                    errorMsg = 'Lỗi server';
                } else if (status === 'timeout') {
                    errorMsg = 'Hết thời gian chờ';
                }

                updateHeader('Lỗi tải danh mục: ' + categoryName);
                updateSubtitle('Không thể kết nối đến server');
                showCategoryError(categoryName + ' (' + errorMsg + ')');

                // Error notification
                showErrorMessage('Không thể tải tin tức từ "' + categoryName + '"');
            }
        });
    }

    // ===== SUPPORT FUNCTIONS =====

    function showCategoryLoading(categoryName) {
        var html = '<div class="category-loading-container text-center">';
        html += '<div class="mb-4">';
        html += '<div class="spinner-border text-primary large-spinner" role="status">';
        html += '<span class="sr-only">Loading...</span>';
        html += '</div>';
        html += '</div>';
        html += '<h4 class="text-primary mb-3">';
        html += '<i class="fas fa-folder-open mr-2"></i>';
        html += 'Đang tải tin tức từ danh mục';
        html += '</h4>';
        html += '<p class="lead text-muted mb-4">';
        html += '"<strong>' + escapeHtml(categoryName) + '</strong>"';
        html += '</p>';
        html += '<div class="loading-dots mb-4">';
        html += '<span class="dot"></span>';
        html += '<span class="dot"></span>';
        html += '<span class="dot"></span>';
        html += '</div>';
        html += '<p class="small text-muted">';
        html += '<i class="fas fa-info-circle mr-1"></i>';
        html += 'Đang tìm kiếm tin tức trong danh mục và các danh mục con...';
        html += '</p>';
        html += '</div>';

        $('#content-container').html(html);
    }

    function addCategoryLoadingState(categoryId) {
        $('[data-category-id="' + categoryId + '"]').addClass('category-loading-state');
    }

    function removeCategoryLoadingState(categoryId) {
        $('[data-category-id="' + categoryId + '"]').removeClass('category-loading-state');
    }

    function showSuccessMessage(message) {
        var html = '<div class="alert alert-success success-message">';
        html += '<div class="d-flex align-items-center">';
        html += '<i class="fas fa-check-circle mr-2" style="font-size: 1.2rem;"></i>';
        html += '<div>';
        html += '<strong>Thành công!</strong><br>';
        html += '<small>' + escapeHtml(message) + '</small>';
        html += '</div>';
        html += '</div>';
        html += '</div>';

        $('body').append(html);

        setTimeout(function () {
            $('.success-message').fadeOut(300, function () {
                $(this).remove();
            });
        }, 3000);
    }

    function showErrorMessage(message) {
        var html = '<div class="alert alert-danger error-message">';
        html += '<div class="d-flex align-items-center">';
        html += '<i class="fas fa-exclamation-triangle mr-2" style="font-size: 1.2rem;"></i>';
        html += '<div>';
        html += '<strong>Lỗi!</strong><br>';
        html += '<small>' + escapeHtml(message) + '</small>';
        html += '</div>';
        html += '</div>';
        html += '</div>';

        $('body').append(html);

        setTimeout(function () {
            $('.error-message').fadeOut(300, function () {
                $(this).remove();
            });
        }, 5000);
    }

    function setActiveCategory(categoryId) {
        $('.category-link, .subcategory-link, .sub-subcategory-link, .level-4-link, .level-5-link, .level-6-link, .level-7-link, .level-8-link')
            .removeClass('active category-loading-state category-active-pulse');

        var $activeCategory = $('[data-category-id="' + categoryId + '"]');
        $activeCategory.addClass('active category-active-pulse');

        var $categoryMenu = $('#categories-menu');
        if ($activeCategory.length && $categoryMenu.length) {
            var categoryTop = $activeCategory.position().top;
            var menuHeight = $categoryMenu.height();
            var menuScrollTop = $categoryMenu.scrollTop();

            if (categoryTop < 0 || categoryTop > menuHeight) {
                $categoryMenu.animate({
                    scrollTop: menuScrollTop + categoryTop - menuHeight / 2
                }, 300);
            }
        }
    }

    // ===== CATEGORY DISPLAY AND EVENTS =====

    function displayCategories(categories) {
        var html = '<div class="categories-menu">';

        for (var i = 0; i < categories.length; i++) {
            var category = categories[i];
            html += '<div class="category-item">';

            // FIXED: Đảm bảo data attributes được set đúng
            html += '<div class="category-link" ';
            html += 'data-category-id="' + category.Id + '" ';
            html += 'data-category-name="' + escapeHtml(category.Name) + '" ';
            html += 'data-level="0">';
            html += '<div class="category-content">';
            html += '<div class="d-flex align-items-center">';
            html += '<div class="category-icon"><i class="fas fa-folder"></i></div>';
            html += '<div class="category-name">' + escapeHtml(category.Name) + '</div>';
            html += '</div>';
            html += '<div class="category-meta">';
            html += '<span class="news-count">' + category.NewsCount + '</span>';

            if (category.HasChildren) {
                html += '<button class="category-toggle-btn toggle-btn" data-parent-id="' + category.Id + '">';
                html += '<i class="fas fa-chevron-right"></i>';
                html += '</button>';
            }

            html += '</div>';
            html += '</div></div>';

            if (category.HasChildren) {
                html += '<div id="subcategories-' + category.Id + '" class="subcategories-container"></div>';
            }

            html += '</div>';
        }

        html += '</div>';
        $('#categories-menu').html(html);
        attachCategoryEventListeners();
    }

    // ===== FIXED: Event Listeners =====
    function attachCategoryEventListeners() {
        console.log('📎 Attaching category event listeners...');

        // FIXED: Event listener với debugging chi tiết
        $('.category-link, .subcategory-link, .sub-subcategory-link, .level-4-link, .level-5-link, .level-6-link, .level-7-link, .level-8-link').off('click').on('click', function (e) {
            if ($(e.target).closest('.toggle-btn').length) {
                return;
            }

            var categoryId = $(this).attr('data-category-id');
            var categoryName = $(this).attr('data-category-name');

            console.log('🖱️ Category clicked:', {
                element: this,
                categoryId: categoryId,
                categoryName: categoryName,
                dataAttributes: {
                    'data-category-id': $(this).attr('data-category-id'),
                    'data-category-name': $(this).attr('data-category-name')
                }
            });

            if (categoryId && categoryName) {
                loadNewsByCategory(parseInt(categoryId), categoryName);
            } else {
                console.error('❌ Missing category data on click');
            }
        });

        $('.toggle-btn').off('click').on('click', function (e) {
            e.stopPropagation();
            var parentId = $(this).attr('data-parent-id');
            var level = $(this).attr('data-level') || 0;
            if (parentId) {
                toggleCategory(parseInt(parentId), parseInt(level));
            }
        });

        console.log('✅ Event listeners attached to ' + $('.category-link').length + ' category links');
    }

    // ===== OTHER REQUIRED FUNCTIONS =====

    function loadSubcategories(parentId, level = 1) {
        console.log('Loading subcategories for parent:', parentId, 'level:', level);

        var container = $('#subcategories-' + parentId);
        var loadingHtml = '<div class="subcategory-loading text-center">' +
            '<div class="spinner-border spinner-border-sm text-primary mr-2" role="status">' +
            '<span class="sr-only">Loading...</span>' +
            '</div>' +
            '<small class="text-muted">Đang tải danh mục con...</small>' +
            '</div>';

        container.html(loadingHtml);

        $.ajax({
            url: '/Home/GetSubcategories',
            type: 'GET',
            data: { parentId: parentId },
            dataType: 'json',
            timeout: 10000,
            success: function (data) {
                if (data.success && data.subcategories && data.subcategories.length > 0) {
                    var html = '';
                    for (var i = 0; i < data.subcategories.length; i++) {
                        var sub = data.subcategories[i];
                        var linkClass = getCategoryLinkClass(level);
                        var iconClass = getCategoryIconClass(level);

                        html += '<div class="category-item">';
                        html += '<div class="' + linkClass + '" ';
                        html += 'data-category-id="' + sub.Id + '" ';
                        html += 'data-category-name="' + escapeHtml(sub.Name) + '" ';
                        html += 'data-level="' + level + '">';
                        html += '<div class="category-content">';
                        html += '<div class="d-flex align-items-center">';
                        html += '<div class="category-icon"><i class="' + iconClass + '"></i></div>';
                        html += '<div class="category-name">' + escapeHtml(sub.Name) + '</div>';
                        html += '</div>';
                        html += '<div class="category-meta">';
                        html += '<span class="news-count">' + sub.NewsCount + '</span>';

                        if (sub.HasChildren) {
                            html += '<button class="category-toggle-btn toggle-btn" data-parent-id="' + sub.Id + '" data-level="' + (level + 1) + '">';
                            html += '<i class="fas fa-chevron-right"></i>';
                            html += '</button>';
                        }

                        html += '</div>';
                        html += '</div></div>';

                        if (sub.HasChildren) {
                            html += '<div id="subcategories-' + sub.Id + '" class="subcategories-container"></div>';
                        }

                        html += '</div>';
                    }

                    container.html(html);
                    attachSubcategoryEventListeners(container, level);
                } else {
                    container.html('<div class="text-center p-2"><small class="text-muted">Không có danh mục con</small></div>');
                }
            },
            error: function (xhr, status, error) {
                console.error('❌ Error loading subcategories:', error);
                var errorHtml = '<div class="text-center p-2">' +
                    '<small class="text-danger">' +
                    '<i class="fas fa-exclamation-triangle mr-1"></i>' +
                    'Lỗi tải dữ liệu' +
                    '</small>' +
                    '<br>' +
                    '<button onclick="loadSubcategories(' + parentId + ', ' + level + ')" class="btn btn-sm btn-outline-secondary mt-1 retry-button">' +
                    '<i class="fas fa-redo mr-1"></i>Thử lại' +
                    '</button>' +
                    '</div>';
                container.html(errorHtml);
            }
        });
    }

    function attachSubcategoryEventListeners(container, level) {
        container.find('.subcategory-link, .sub-subcategory-link, .level-4-link, .level-5-link, .level-6-link, .level-7-link, .level-8-link').off('click').on('click', function (e) {
            if ($(e.target).closest('.toggle-btn').length) {
                return;
            }

            var categoryId = $(this).attr('data-category-id');
            var categoryName = $(this).attr('data-category-name');

            if (categoryId && categoryName) {
                loadNewsByCategory(parseInt(categoryId), categoryName);
            }
        });

        container.find('.toggle-btn').off('click').on('click', function (e) {
            e.stopPropagation();
            var parentId = $(this).attr('data-parent-id');
            var nextLevel = $(this).attr('data-level') || level + 1;
            if (parentId) {
                toggleCategory(parseInt(parentId), parseInt(nextLevel));
            }
        });
    }

    function getCategoryLinkClass(level) {
        switch (level) {
            case 1: return 'subcategory-link';
            case 2: return 'sub-subcategory-link';
            case 3: return 'level-4-link';
            case 4: return 'level-5-link';
            case 5: return 'level-6-link';
            case 6: return 'level-7-link';
            case 7: return 'level-8-link';
            default: return 'level-8-link';
        }
    }

    function getCategoryIconClass(level) {
        switch (level) {
            case 1: return 'fas fa-folder-open';
            case 2: return 'fas fa-file-alt';
            case 3: return 'fas fa-file';
            case 4: return 'fas fa-circle';
            default: return 'fas fa-dot-circle';
        }
    }

    function toggleCategory(categoryId, level = 0) {
        var container = $('#subcategories-' + categoryId);
        var toggleBtn = $('[data-parent-id="' + categoryId + '"]');

        if (container.hasClass('expanded')) {
            container.removeClass('expanded').hide();
            toggleBtn.removeClass('expanded').find('i').removeClass('fa-chevron-down').addClass('fa-chevron-right');
        } else {
            container.html('<div class="text-center p-3"><small class="text-muted"><i class="fa fa-spinner fa-spin"></i> Đang tải...</small></div>');
            container.addClass('expanded').show();
            toggleBtn.addClass('expanded').find('i').removeClass('fa-chevron-right').addClass('fa-chevron-down');
            loadSubcategories(categoryId, level + 1);
        }
    }

    function loadRecentNews() {
        console.log('Loading recent news...');
        $.ajax({
            url: '/Home/GetRecentNews',
            type: 'GET',
            data: { count: 20 },
            dataType: 'json',
            success: function (data) {
                if (data.success && data.news && data.news.length > 0) {
                    displayNews(data.news);
                } else {
                    showEmptyNews();
                }
            },
            error: function (xhr, status, error) {
                console.error('Error loading news:', error);
                showErrorNews('Không thể tải tin tức: ' + error);
            }
        });
    }

    function loadCategories() {
        console.log('Loading categories...');
        $.ajax({
            url: '/Home/GetCategoriesTree',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                if (data.success && data.categories) {
                    displayCategories(data.categories);
                } else {
                    showEmptyCategories();
                }
            },
            error: function (xhr, status, error) {
                console.error('Error loading categories:', error);
                showErrorCategories();
            }
        });
    }

    function performSearch() {
        var query = $('#search-input').val().trim();
        if (query.length < 2) {
            alert('Vui lòng nhập ít nhất 2 ký tự để tìm kiếm');
            return;
        }

        currentMode = 'search';
        updateHeader('Kết quả tìm kiếm: "' + query + '"');
        updateSubtitle('Tìm kiếm trong tiêu đề, trích ngắn và nội dung');
        showLoading();

        $.ajax({
            url: '/Home/QuickSearch',
            type: 'GET',
            data: { term: query, maxResults: 20 },
            dataType: 'json',
            success: function (data) {
                if (data.success && data.results && data.results.length > 0) {
                    displaySearchResults(data.results, query);
                } else {
                    showNoSearchResults(query);
                }
            },
            error: function (xhr, status, error) {
                console.error('Search error:', error);
                showSearchError('Lỗi tìm kiếm: ' + error);
            }
        });
    }

    function clearSearch() {
        $('#search-input').val('');
        currentMode = 'default';
        updateHeader('Tin tức mới nhất');
        updateSubtitle('Cập nhật tin tức mới nhất trong hệ thống');
        $('.category-link, .subcategory-link, .sub-subcategory-link, .level-4-link, .level-5-link, .level-6-link, .level-7-link, .level-8-link').removeClass('active');
        loadRecentNews();
    }

    function displayNews(newsArray) {
        var html = '<div class="row">';
        for (var i = 0; i < newsArray.length; i++) {
            html += generateNewsCard(newsArray[i]);
        }
        html += '</div>';

        if (currentMode === 'default') {
            html += '<div class="text-center mt-4">';
            html += '<a href="/News" class="btn btn-primary btn-lg">';
            html += '<i class="fa fa-eye mr-2"></i>Xem tất cả tin tức';
            html += '</a></div>';
        }

        $('#content-container').html(html);
    }

    function displaySearchResults(results, query) {
        var html = '<div class="alert alert-info">';
        html += '<strong><i class="fas fa-search mr-2"></i>Tìm thấy ' + results.length + ' kết quả cho từ khóa: "' + escapeHtml(query) + '"</strong>';
        html += '</div><div class="row">';

        for (var i = 0; i < results.length; i++) {
            html += generateNewsCard(results[i]);
        }

        html += '</div>';
        html += '<div class="text-center mt-4">';
        html += '<button onclick="clearSearch()" class="btn btn-outline-secondary btn-lg">';
        html += '<i class="fa fa-arrow-left mr-1"></i> Quay lại trang chủ';
        html += '</button>';
        html += '</div>';

        $('#content-container').html(html);
    }

    function updateHeader(title) {
        $('#content-title').html('<i class="fa fa-newspaper mr-2"></i>' + title);
    }

    function updateSubtitle(subtitle) {
        $('#content-subtitle').text(subtitle);
    }

    function showLoading() {
        $('#content-container').html(
            '<div class="loading-spinner">' +
            '<div class="spinner-border text-primary"></div>' +
            '<p>Đang tải...</p>' +
            '</div>'
        );
    }

    function loadHomePage() {
        location.reload();
    }

    function showEmptyNews() {
        $('#content-container').html(
            '<div class="alert alert-info text-center">' +
            '<h4><i class="fa fa-info-circle"></i> Chưa có tin tức</h4>' +
            '<p>Hiện tại chưa có tin tức nào trong hệ thống.</p>' +
            '<a href="/News/Create" class="btn btn-primary">' +
            '<i class="fa fa-plus"></i> Thêm tin tức đầu tiên</a>' +
            '</div>'
        );
    }

    function showErrorNews(message) {
        $('#content-container').html(
            '<div class="alert alert-danger text-center">' +
            '<h4><i class="fa fa-exclamation-triangle"></i> Lỗi</h4>' +
            '<p>' + escapeHtml(message) + '</p>' +
            '<button onclick="loadRecentNews()" class="btn btn-secondary">' +
            '<i class="fa fa-refresh"></i> Thử lại</button>' +
            '</div>'
        );
    }

    function showNoSearchResults(query) {
        $('#content-container').html(
            '<div class="alert alert-warning text-center">' +
            '<h4><i class="fa fa-search"></i> Không tìm thấy kết quả</h4>' +
            '<p>Không có tin tức nào chứa từ khóa: "<strong>' + escapeHtml(query) + '</strong>"</p>' +
            '<button onclick="clearSearch()" class="btn btn-primary">Về trang chủ</button>' +
            '</div>'
        );
    }

    function showSearchError(message) {
        $('#content-container').html(
            '<div class="alert alert-danger text-center">' +
            '<h4><i class="fa fa-exclamation-triangle"></i> Lỗi tìm kiếm</h4>' +
            '<p>' + escapeHtml(message) + '</p>' +
            '<button onclick="clearSearch()" class="btn btn-primary">Về trang chủ</button>' +
            '</div>'
        );
    }

    function showNoCategoryNews(categoryName) {
        $('#content-container').html(
            '<div class="alert alert-info text-center">' +
            '<h4><i class="fa fa-folder-open"></i> Danh mục trống</h4>' +
            '<p>Danh mục "<strong>' + escapeHtml(categoryName) + '</strong>" chưa có tin tức nào.</p>' +
            '<div class="mt-3">' +
            '<a href="/News/Create" class="btn btn-primary mr-2">' +
            '<i class="fa fa-plus"></i> Thêm tin tức mới</a>' +
            '<button onclick="clearSearch()" class="btn btn-secondary">' +
            '<i class="fa fa-arrow-left"></i> Về trang chủ</button>' +
            '</div>' +
            '</div>'
        );
    }

    function showCategoryError(categoryName) {
        $('#content-container').html(
            '<div class="alert alert-danger text-center">' +
            '<h4><i class="fa fa-exclamation-triangle"></i> Lỗi tải tin tức</h4>' +
            '<p>Không thể tải tin tức từ danh mục: "<strong>' + escapeHtml(categoryName) + '</strong>"</p>' +
            '<div class="mt-3">' +
            '<button onclick="loadCategories()" class="btn btn-warning mr-2">' +
            '<i class="fa fa-refresh"></i> Thử lại</button>' +
            '<button onclick="clearSearch()" class="btn btn-secondary">' +
            '<i class="fa fa-arrow-left"></i> Về trang chủ</button>' +
            '</div>' +
            '</div>'
        );
    }

    function showEmptyCategories() {
        $('#categories-menu').html(
            '<div class="text-center p-3">' +
            '<p class="text-muted mb-2">Chưa có danh mục nào</p>' +
            '<a href="/Category/Create" class="btn btn-sm btn-success">' +
            '<i class="fa fa-plus"></i> Thêm danh mục</a>' +
            '</div>'
        );
    }

    function showErrorCategories() {
        $('#categories-menu').html(
            '<div class="text-center p-3">' +
            '<p class="text-muted mb-2">Không thể tải danh mục</p>' +
            '<button onclick="loadCategories()" class="btn btn-sm btn-secondary">' +
            '<i class="fa fa-refresh"></i> Thử lại</button>' +
            '</div>'
        );
    }

    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ===== DEBUG FUNCTIONS - Có thể xóa sau khi hoạt động ổn định =====

    function testCategoryClick() {
        console.log('🧪 Testing category click manually...');
        var firstCategory = $('.category-link').first();
        if (firstCategory.length > 0) {
            var categoryId = firstCategory.attr('data-category-id');
            var categoryName = firstCategory.attr('data-category-name');
            console.log('Manual test - categoryId:', categoryId, 'categoryName:', categoryName);
            if (categoryId && categoryName) {
                loadNewsByCategory(parseInt(categoryId), categoryName);
            }
        } else {
            console.log('❌ No categories found for testing');
        }
    }

    function testDisplayCategoryNews() {
        console.log('🧪 Testing displayCategoryNews function...');

        var testData = [
            {
                Id: 999,
                Title: "🧪 TEST TIN TỨC - Kiểm tra hiển thị",
                Summary: "Đây là tin tức test để kiểm tra function displayCategoryNews có hoạt động đúng không",
                CreatedDate: "06/06/2024",
                Categories: ["Test Category", "Debug"]
            },
            {
                Id: 998,
                Title: "🧪 TEST TIN TỨC 2 - Function Test",
                Summary: "Tin tức test thứ hai để kiểm tra nhiều items",
                CreatedDate: "05/06/2024",
                Categories: ["Test Category"]
            }
        ];

        console.log('📊 Calling displayCategoryNews with test data...');
        displayCategoryNews(testData, "🧪 TEST CATEGORY", 2);

        setTimeout(function () {
            var contentHtml = $('#content-container').html();
            if (contentHtml && contentHtml.indexOf('TEST TIN TỨC') > -1) {
                console.log('✅ displayCategoryNews WORKS! Content updated successfully.');
            } else {
                console.error('❌ displayCategoryNews called but content not updated');
            }
        }, 100);
    }

    function debugAllFunctions() {
        console.log('🔍 Checking all required functions...');

        var requiredFunctions = [
            'displayCategoryNews',
            'loadNewsByCategory',
            'generateNewsCard',
            'showCategoryLoading',
            'setActiveCategory',
            'attachCategoryEventListeners',
            'loadCategories',
            'loadRecentNews'
        ];

        var missingFunctions = [];

        requiredFunctions.forEach(function (funcName) {
            if (typeof window[funcName] === 'function') {
                console.log('✅ ' + funcName + ' - OK');
            } else {
                console.error('❌ ' + funcName + ' - MISSING!');
                missingFunctions.push(funcName);
            }
        });

        if (missingFunctions.length === 0) {
            console.log('🎉 All functions are available!');
            return true;
        } else {
            console.error('❌ Missing functions:', missingFunctions);
            return false;
        }
    }

    // ===== MAIN INITIALIZATION =====
    console.log('📦 JavaScript module loaded successfully');
    console.log('🔧 Key functions defined:', typeof displayCategoryNews, typeof loadNewsByCategory);

    // Kiểm tra functions khi load
    $(document).ready(function () {
        console.log('✅ Document ready, checking functions...');
        debugAllFunctions();
    });
    </script>