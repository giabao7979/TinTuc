@{
    ViewBag.Title = "Trang chủ - Tin tức mới nhất";
}
<link href="~/Content/css/home-page.css" rel="stylesheet" />

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="jumbotron bg-primary text-white text-center">
                <h1 class="display-4">Hệ thống quản lý tin tức</h1>
                <p class="lead">Cập nhật tin tức mới nhất và quản lý nội dung hiệu quả</p>
                <hr class="my-4 bg-white">
                <div class="row">
                    <div class="col-md-3">
                        <a href="@Url.Action("Create", "News")" class="btn btn-light btn-lg btn-block">
                            <i class="fa fa-plus"></i> Thêm tin tức
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="@Url.Action("Index", "News")" class="btn btn-light btn-lg btn-block">
                            <i class="fa fa-list"></i> Quản lý tin tức
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="@Url.Action("Index", "Category")" class="btn btn-light btn-lg btn-block">
                            <i class="fa fa-folder"></i> Quản lý danh mục
                        </a>
                    </div>
                    <div class="col-md-3">
                        <button onclick="loadHomePage()" class="btn btn-light btn-lg btn-block">
                            <i class="fa fa-home"></i> Tải lại trang
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tìm kiếm và Danh mục -->
    <div class="row mb-4">
        <!-- Danh mục -->
        <div class="col-md-4">
            <div class="card shadow categories-card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fa fa-folder"></i> Danh mục tin tức</h5>
                </div>
                <div class="card-body">
                    <div id="categories-menu">
                        <div class="text-center p-3">
                            <i class="fa fa-spinner fa-spin"></i>
                            <p class="mb-0 mt-2">Đang tải danh mục...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tìm kiếm và Nội dung -->
        <div class="col-md-8">
            <!-- Tìm kiếm -->
            <div class="card shadow mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fa fa-search"></i> Tìm kiếm tin tức</h5>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" id="search-input" class="form-control form-control-lg"
                               placeholder="Nhập từ khóa tìm kiếm tin tức...">
                        <div class="input-group-append">
                            <button type="button" onclick="performSearch()" class="btn btn-primary btn-lg">
                                <i class="fa fa-search"></i> Tìm kiếm
                            </button>
                            <button type="button" onclick="clearSearch()" class="btn btn-secondary btn-lg">
                                <i class="fa fa-times"></i> Xóa
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nội dung -->
            <div class="card shadow">
                <div class="card-header bg-primary text-white" id="content-header">
                    <h3 class="mb-0" id="content-title">
                        <i class="fa fa-newspaper"></i> Tin tức mới nhất
                    </h3>
                </div>
                <div class="card-body">
                    <div id="content-container">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <p class="mt-3">Đang tải tin tức...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
// Global variables
var currentMode = 'default';
var searchTimeout;

// Initialize page - Use vanilla JS first, then jQuery
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, checking jQuery...');

    // Check if jQuery is loaded
    if (typeof $ === 'undefined') {
        console.error('jQuery is not loaded!');
        document.getElementById('content-container').innerHTML =
            '<div class="alert alert-danger text-center">' +
            '<h4>Lỗi: jQuery không được tải</h4>' +
            '<p>Vui lòng kiểm tra lại việc tải jQuery library.</p>' +
            '</div>';
        return;
    }

    console.log('jQuery loaded, starting to load data...');
    loadRecentNews();
    loadCategories();
});

// Alternative: Use window.onload if DOMContentLoaded doesn't work
window.onload = function() {
    if (typeof $ !== 'undefined') {
        console.log('Page fully loaded, jQuery available');
        loadRecentNews();
        loadCategories();
    }
};

// Load recent news
function loadRecentNews() {
    console.log('Loading recent news...');

    if (typeof $ === 'undefined') {
        console.error('jQuery not available in loadRecentNews');
        return;
    }

    $.ajax({
        url: '@Url.Action("GetRecentNews", "Home")',
        type: 'GET',
        data: { count: 20 },
        dataType: 'json',
        success: function(data) {
            console.log('Recent news loaded:', data);
            if (data.success && data.news && data.news.length > 0) {
                displayNews(data.news);
            } else {
                showEmptyNews();
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading news:', error);
            console.error('XHR:', xhr);
            showErrorNews('Không thể tải tin tức: ' + error);
        }
    });
}

// Load categories
function loadCategories() {
    console.log('Loading categories...');

    if (typeof $ === 'undefined') {
        console.error('jQuery not available in loadCategories');
        return;
    }

    $.ajax({
        url: '@Url.Action("GetCategoriesTree", "Home")',
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            console.log('Categories loaded:', data);
            if (data.success && data.categories) {
                displayCategories(data.categories);
            } else {
                showEmptyCategories();
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading categories:', error);
            console.error('XHR:', xhr);
            showErrorCategories();
        }
    });
}

// Search functionality
function performSearch() {
    var query = document.getElementById('search-input').value.trim();

    if (query.length < 2) {
        alert('Vui lòng nhập ít nhất 2 ký tự để tìm kiếm');
        return;
    }

    currentMode = 'search';
    updateHeader('Kết quả tìm kiếm: "' + query + '"');
    showLoading();

    if (typeof $ === 'undefined') {
        showSearchError('jQuery không khả dụng');
        return;
    }

    $.ajax({
        url: '@Url.Action("QuickSearch", "Home")',
        type: 'GET',
        data: { term: query, maxResults: 20 },
        dataType: 'json',
        success: function(data) {
            if (data.success && data.results && data.results.length > 0) {
                displaySearchResults(data.results, query);
            } else {
                showNoSearchResults(query);
            }
        },
        error: function(xhr, status, error) {
            console.error('Search error:', error);
            showSearchError('Lỗi tìm kiếm: ' + error);
        }
    });
}

function clearSearch() {
    document.getElementById('search-input').value = '';
    currentMode = 'default';
    updateHeader('Tin tức mới nhất');
    loadRecentNews();
}

// Load news by category - SỬA LẠI URL ĐÚNG
    function loadNewsByCategory(categoryId, categoryName) {
        console.log('Loading news for category:', categoryId, categoryName);

        currentMode = 'category';
        updateHeader('Tin tức trong danh mục: ' + categoryName);
        setActiveCategory(categoryId);
        showLoading();

        if (typeof $ === 'undefined') {
            showCategoryError(categoryName);
            return;
        }

        $.ajax({
            url: '/Home/GetNewsByCategory',
            type: 'GET',
            data: { categoryId: categoryId, pageSize: 20 },
            dataType: 'json',
            timeout: 10000,
            success: function (data) {
                console.log('AJAX success:', data);

                if (data.success && data.data && data.data.length > 0) {
                    // Hiển thị tin tức với layout đẹp
                    var html = '<div class="alert alert-success mb-4">';
                    html += '<i class="fa fa-check-circle mr-2"></i>';
                    html += '<strong>Tìm thấy ' + data.data.length + ' tin tức trong danh mục: "' + escapeHtml(categoryName) + '"</strong>';
                    html += '</div>';

                    html += '<div class="row">';

                    for (var i = 0; i < data.data.length; i++) {
                        var news = data.data[i];
                        html += '<div class="col-lg-4 col-md-6 mb-4">';
                        html += '<div class="card h-100 shadow-sm">';
                        html += '<div class="card-body d-flex flex-column">';

                        // Tiêu đề
                        html += '<h5 class="card-title">';
                        html += '<a href="/News/Details/' + news.Id + '" class="text-dark text-decoration-none">';
                        html += escapeHtml(news.Title || 'Không có tiêu đề');
                        html += '</a>';
                        html += '</h5>';

                        // Trích ngắn
                        if (news.Summary) {
                            html += '<p class="card-text text-muted flex-grow-1">';
                            html += escapeHtml(news.Summary);
                            html += '</p>';
                        }

                        // Footer với ngày
                        html += '<div class="mt-auto">';
                        html += '<div class="d-flex justify-content-between align-items-center">';
                        html += '<small class="text-muted">';
                        html += '<i class="fa fa-calendar mr-1"></i>';
                        html += escapeHtml(news.CreatedDate || 'Không có ngày');
                        html += '</small>';
                        html += '<div>';
                        html += '<a href="/News/Details/' + news.Id + '" class="btn btn-sm btn-primary">Xem chi tiết</a>';
                        html += '</div>';
                        html += '</div>';
                        html += '</div>';

                        html += '</div></div></div>';
                    }

                    html += '</div>';

                    // Nút quay lại
                    html += '<div class="text-center mt-4">';
                    html += '<button onclick="clearSearch()" class="btn btn-outline-secondary">';
                    html += '<i class="fa fa-arrow-left mr-1"></i> Quay lại trang chủ';
                    html += '</button>';
                    html += '</div>';

                    document.getElementById('content-container').innerHTML = html;

                    // Scroll to content
                    document.getElementById('content-container').scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });

                } else if (data.success) {
                    // Không có tin tức
                    showNoCategoryNews(categoryName);
                } else {
                    // API trả về lỗi
                    showCategoryError(categoryName + ' (Lỗi: ' + (data.message || 'Không xác định') + ')');
                }
            },
            error: function (xhr, status, error) {
                console.error('AJAX error:', error);
                showCategoryError(categoryName + ' (Lỗi kết nối: ' + error + ')');
            }
        });
    }

// Display functions
function displayNews(newsArray) {
    var html = '<div class="row">';

    for (var i = 0; i < newsArray.length; i++) {
        var news = newsArray[i];
        html += generateNewsCard(news);
    }

    html += '</div>';

    if (currentMode === 'default') {
        html += '<div class="text-center mt-4">';
        html += '<a href="@Url.Action("Index", "News")" class="btn btn-primary btn-lg">';
        html += '<i class="fa fa-eye"></i> Xem tất cả tin tức';
        html += '</a></div>';
    }

    document.getElementById('content-container').innerHTML = html;
}

function displaySearchResults(results, query) {
    var html = '<div class="alert alert-info">';
    html += '<strong>Tìm thấy ' + results.length + ' kết quả cho từ khóa: "' + escapeHtml(query) + '"</strong>';
    html += '</div><div class="row">';

    for (var i = 0; i < results.length; i++) {
        var news = results[i];
        html += generateNewsCard(news);
    }

    html += '</div>';
    document.getElementById('content-container').innerHTML = html;
}

function displayCategoryNews(newsArray, categoryName) {
    var html = '<div class="alert alert-success">';
    html += '<strong>Tìm thấy ' + newsArray.length + ' tin tức trong danh mục: "' + escapeHtml(categoryName) + '"</strong>';
    html += '</div><div class="row">';

    for (var i = 0; i < newsArray.length; i++) {
        var news = newsArray[i];
        html += generateNewsCard(news);
    }

    html += '</div>';
    document.getElementById('content-container').innerHTML = html;
}

// Load subcategories when expand button is clicked
function toggleCategory(categoryId) {
    console.log('toggleCategory called with:', categoryId);

    var container = document.getElementById('subcategories-' + categoryId);
    var toggleBtn = document.querySelector('[data-parent-id="' + categoryId + '"]');

    if (!container) {
        console.error('Container not found for category:', categoryId);
        return;
    }

    if (container.style.display === 'none' || container.style.display === '') {
        // Show loading
        container.innerHTML = '<div class="text-center p-2"><small class="text-muted"><i class="fa fa-spinner fa-spin"></i> Đang tải...</small></div>';
        container.style.display = 'block';
        if (toggleBtn) {
            toggleBtn.innerHTML = '<i class="fa fa-chevron-down"></i>';
        }

        // Load subcategories
        loadSubcategories(categoryId);
    } else {
        // Hide
        container.style.display = 'none';
        if (toggleBtn) {
            toggleBtn.innerHTML = '<i class="fa fa-chevron-right"></i>';
        }
    }
}

function loadSubcategories(parentId) {
    console.log('loadSubcategories called with:', parentId);

    if (typeof $ === 'undefined') {
        console.error('jQuery not available for loading subcategories');
        return;
    }

    $.ajax({
        url: '/Home/GetSubcategories',
        type: 'GET',
        data: { parentId: parentId },
        dataType: 'json',
        success: function(data) {
            console.log('Subcategories loaded for parent ' + parentId + ':', data);
            var container = document.getElementById('subcategories-' + parentId);
            if (container) {
                if (data.success && data.subcategories && data.subcategories.length > 0) {
                    var html = '';
                    for (var i = 0; i < data.subcategories.length; i++) {
                        var sub = data.subcategories[i];
                        html += '<div class="subcategory-item ml-3 mb-1">';
                        html += '<div class="category-link p-2 border rounded" data-category-id="' + sub.Id + '" data-category-name="' + escapeHtml(sub.Name) + '" style="cursor: pointer;">';
                        html += '<div class="d-flex justify-content-between align-items-center">';
                        html += '<div><i class="fa fa-folder-o text-success mr-2"></i><span>' + escapeHtml(sub.Name) + '</span></div>';
                        html += '<div>';
                        html += '<span class="badge badge-info mr-2">' + sub.NewsCount + '</span>';
                        if (sub.HasChildren) {
                            html += '<button class="btn btn-sm btn-outline-secondary toggle-btn" data-parent-id="' + sub.Id + '">';
                            html += '<i class="fa fa-chevron-right"></i>';
                            html += '</button>';
                        }
                        html += '</div>';
                        html += '</div></div>';
                        if (sub.HasChildren) {
                            html += '<div id="subcategories-' + sub.Id + '" style="display: none;"></div>';
                        }
                        html += '</div>';
                    }
                    container.innerHTML = html;

                    // Attach events for subcategories
                    attachSubcategoryEventListeners(container);
                } else {
                    container.innerHTML = '<div class="text-center p-2"><small class="text-muted">Không có danh mục con</small></div>';
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading subcategories:', error);
            var container = document.getElementById('subcategories-' + parentId);
            if (container) {
                container.innerHTML = '<div class="text-center p-2"><small class="text-danger">Lỗi tải dữ liệu</small></div>';
            }
        }
    });
}

// Attach event listeners for subcategories
function attachSubcategoryEventListeners(container) {
    var subCategoryLinks = container.querySelectorAll('.category-link');
    for (var i = 0; i < subCategoryLinks.length; i++) {
        subCategoryLinks[i].addEventListener('click', function(e) {
            if (e.target.closest('.toggle-btn')) {
                return;
            }

            var categoryId = this.getAttribute('data-category-id');
            var categoryName = this.getAttribute('data-category-name');

            console.log('Subcategory clicked:', categoryId, categoryName);
            loadNewsByCategory(parseInt(categoryId), categoryName);
        });
    }

    var subToggleButtons = container.querySelectorAll('.toggle-btn');
    for (var j = 0; j < subToggleButtons.length; j++) {
        subToggleButtons[j].addEventListener('click', function(e) {
            e.stopPropagation();
            var parentId = this.getAttribute('data-parent-id');
            console.log('Sub toggle clicked for parent:', parentId);
            toggleCategory(parseInt(parentId));
        });
    }
}

function displayCategories(categories) {
    var html = '<div class="categories-menu">';

    for (var i = 0; i < categories.length; i++) {
        var category = categories[i];
        html += '<div class="category-item mb-2">';

        // Sử dụng data attribute thay vì onclick inline
        html += '<div class="category-link p-2 border rounded" data-category-id="' + category.Id + '" data-category-name="' + escapeHtml(category.Name) + '" style="cursor: pointer;">';
        html += '<div class="d-flex justify-content-between align-items-center">';
        html += '<div><i class="fa fa-folder text-primary mr-2"></i><span>' + escapeHtml(category.Name) + '</span></div>';
        html += '<div>';
        html += '<span class="badge badge-primary mr-2">' + category.NewsCount + '</span>';
        if (category.HasChildren) {
            html += '<button class="btn btn-sm btn-outline-primary toggle-btn" data-parent-id="' + category.Id + '">';
            html += '<i class="fa fa-chevron-right"></i>';
            html += '</button>';
        }
        html += '</div>';
        html += '</div></div>';

        // Container for subcategories
        if (category.HasChildren) {
            html += '<div id="subcategories-' + category.Id + '" style="display: none;"></div>';
        }

        html += '</div>';
    }

    html += '</div>';
    document.getElementById('categories-menu').innerHTML = html;

    // Attach event listeners after HTML is added
    attachCategoryEventListeners();
}

// Function to attach event listeners
function attachCategoryEventListeners() {
    // Category click events
    var categoryLinks = document.querySelectorAll('.category-link');
    for (var i = 0; i < categoryLinks.length; i++) {
        categoryLinks[i].addEventListener('click', function(e) {
            // Prevent event if clicking on toggle button
            if (e.target.closest('.toggle-btn')) {
                return;
            }

            var categoryId = this.getAttribute('data-category-id');
            var categoryName = this.getAttribute('data-category-name');

            console.log('Category clicked:', categoryId, categoryName);
            loadNewsByCategory(parseInt(categoryId), categoryName);
        });
    }

    // Toggle button events
    var toggleButtons = document.querySelectorAll('.toggle-btn');
    for (var j = 0; j < toggleButtons.length; j++) {
        toggleButtons[j].addEventListener('click', function(e) {
            e.stopPropagation();
            var parentId = this.getAttribute('data-parent-id');
            console.log('Toggle clicked for parent:', parentId);
            toggleCategory(parseInt(parentId));
        });
    }
}

// Generate news card - BỎ PHẦN HIỂN THỊ DANH MỤC
function generateNewsCard(news) {
    var html = '<div class="col-lg-4 col-md-6 mb-3">';
    html += '<div class="card h-100">';
    html += '<div class="card-body">';
    html += '<h6 class="card-title">';
    html += '<a href="@Url.Action("Details", "News")/' + news.Id + '">' + escapeHtml(news.Title) + '</a>';
    html += '</h6>';

    // BỎ PHẦN HIỂN THỊ DANH MỤC
    /*
    if (news.Categories && news.Categories.length > 0) {
        html += '<div class="mb-2">';
        for (var j = 0; j < news.Categories.length; j++) {
            html += '<span class="badge badge-secondary mr-1">' + escapeHtml(news.Categories[j]) + '</span>';
        }
        html += '</div>';
    }
    */

    if (news.Summary) {
        var summary = news.Summary.length > 100 ? news.Summary.substring(0, 100) + '...' : news.Summary;
        html += '<p class="card-text">' + escapeHtml(summary) + '</p>';
    }

    html += '<div class="mt-auto">';
    html += '<small class="text-muted"><i class="fa fa-calendar mr-1"></i>' + escapeHtml(news.CreatedDate) + '</small>';
    html += '</div></div></div></div>';

    return html;
}

// Utility functions
function updateHeader(title) {
    document.getElementById('content-title').innerHTML = '<i class="fa fa-newspaper"></i> ' + title;
}

function showLoading() {
    document.getElementById('content-container').innerHTML =
        '<div class="text-center">' +
        '<div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>' +
        '<p class="mt-3">Đang tải...</p>' +
        '</div>';
}

    function setActiveCategory(categoryId) {
        // Remove active state from all categories
        var links = document.querySelectorAll('.category-link');
        for (var i = 0; i < links.length; i++) {
            links[i].classList.remove('bg-primary', 'text-white');
            links[i].classList.add('bg-light');
        }

        // Add active state to clicked category
        var clickedLinks = document.querySelectorAll('[data-category-id="' + categoryId + '"]');
        for (var j = 0; j < clickedLinks.length; j++) {
            clickedLinks[j].classList.remove('bg-light');
            clickedLinks[j].classList.add('bg-primary', 'text-white');
        }
    }
function loadHomePage() {
    location.reload();
}

// Error states
function showEmptyNews() {
    document.getElementById('content-container').innerHTML =
        '<div class="alert alert-info text-center">' +
        '<h4><i class="fa fa-info-circle"></i> Chưa có tin tức</h4>' +
        '<p>Hiện tại chưa có tin tức nào trong hệ thống.</p>' +
        '<a href="@Url.Action("Create", "News")" class="btn btn-primary">' +
        '<i class="fa fa-plus"></i> Thêm tin tức đầu tiên</a>' +
        '</div>';
}

function showErrorNews(message) {
    document.getElementById('content-container').innerHTML =
        '<div class="alert alert-danger text-center">' +
        '<h4><i class="fa fa-exclamation-triangle"></i> Lỗi</h4>' +
        '<p>' + escapeHtml(message) + '</p>' +
        '<button onclick="loadRecentNews()" class="btn btn-secondary">' +
        '<i class="fa fa-refresh"></i> Thử lại</button>' +
        '</div>';
}

function showNoSearchResults(query) {
    document.getElementById('content-container').innerHTML =
        '<div class="alert alert-warning text-center">' +
        '<h4><i class="fa fa-search"></i> Không tìm thấy kết quả</h4>' +
        '<p>Không có tin tức nào chứa từ khóa: "<strong>' + escapeHtml(query) + '</strong>"</p>' +
        '<button onclick="clearSearch()" class="btn btn-primary">Về trang chủ</button>' +
        '</div>';
}

function showSearchError(message) {
    document.getElementById('content-container').innerHTML =
        '<div class="alert alert-danger text-center">' +
        '<h4><i class="fa fa-exclamation-triangle"></i> Lỗi tìm kiếm</h4>' +
        '<p>' + escapeHtml(message) + '</p>' +
        '<button onclick="clearSearch()" class="btn btn-primary">Về trang chủ</button>' +
        '</div>';
}

function showNoCategoryNews(categoryName) {
    document.getElementById('content-container').innerHTML =
        '<div class="alert alert-info text-center">' +
        '<h4><i class="fa fa-folder-open"></i> Danh mục trống</h4>' +
        '<p>Danh mục "<strong>' + escapeHtml(categoryName) + '</strong>" chưa có tin tức nào.</p>' +
        '<button onclick="clearSearch()" class="btn btn-primary">Về trang chủ</button>' +
        '</div>';
}

function showCategoryError(categoryName) {
    document.getElementById('content-container').innerHTML =
        '<div class="alert alert-danger text-center">' +
        '<h4><i class="fa fa-exclamation-triangle"></i> Lỗi tải tin tức</h4>' +
        '<p>Không thể tải tin tức từ danh mục: "<strong>' + escapeHtml(categoryName) + '</strong>"</p>' +
        '<button onclick="clearSearch()" class="btn btn-primary">Về trang chủ</button>' +
        '</div>';
}

function showEmptyCategories() {
    document.getElementById('categories-menu').innerHTML =
        '<div class="text-center p-3">' +
        '<p class="text-muted mb-2">Chưa có danh mục nào</p>' +
        '<a href="@Url.Action("Create", "Category")" class="btn btn-sm btn-success">' +
        '<i class="fa fa-plus"></i> Thêm danh mục</a>' +
        '</div>';
}

function showErrorCategories() {
    document.getElementById('categories-menu').innerHTML =
        '<div class="text-center p-3">' +
        '<p class="text-muted mb-2">Không thể tải danh mục</p>' +
        '<button onclick="loadCategories()" class="btn btn-sm btn-secondary">' +
        '<i class="fa fa-refresh"></i> Thử lại</button>' +
        '</div>';
}

function escapeHtml(text) {
    if (!text) return '';
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Handle search input events with vanilla JS
document.addEventListener('DOMContentLoaded', function() {
    var searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                performSearch();
                return;
            }

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                var query = searchInput.value.trim();
                if (query.length >= 2) {
                    performSearch();
                } else if (query.length === 0) {
                    clearSearch();
                }
            }, 500);
        });
    }
});
</script>